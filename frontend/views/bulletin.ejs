<%- include('partials/header', { title: 'Bulletin de notes' }) %>

<style>
  /* ===== STYLES PROFESSIONNELS ===== */
  
  .search-container {
    background: linear-gradient(135deg, #092fdb 0%, #1136db 100%);
    border-radius: 12px;
    padding: 30px;
    color: white;
    margin-bottom: 20px;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
  }
  
  .search-container h3 {
    margin-bottom: 20px;
    font-weight: 700;
  }
  
  .autocomplete-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-radius: 4px;
    max-height: 300px;
    overflow-y: auto;
    z-index: 1000;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
  
  .autocomplete-results .result-item {
    padding: 10px;
    border-bottom: 1px solid #df1212;
    cursor: pointer;
    color: #333;
  }
  .bulletin-header {
    text-align: center;
    padding-bottom: 10px;
    margin-bottom: 13px;
  }
  
  .etablissement-nom {
    font-size: 20px;
    font-weight: 700;
    color: #2c3e50;
    letter-spacing: 1px;
  }
  
  .etablissement-adresse {
    font-size: 12px;
    color: #131414;
    margin-top: 5px;
  }
  
  .bulletin-titre {
    font-size: 18px;
    font-weight: 700;
    color: #1237db;
    margin-top: 15px;
    text-transform: uppercase;
    letter-spacing: 2px;
  }
  
  .bulletin-annee {
    font-size: 13px;
    color: #555;
    margin-top: 8px;
    font-style: italic;
  }
  
  .student-info {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 10px;
    padding: 13px;
    background: #f8f9fa;
    border-radius: 6px;
    border-left: 4px solid #ebedf1;
  }
  
  .info-row {
    display: flex;
    gap: 12px;
    padding-bottom: 8px;
    align-items: center;
  }
  
  .info-label {
    font-weight: 600;
    color: #2c3e50;
    min-width: 120px;
  }
  
  .info-value {
    color: #333;
    font-weight: 500;
  }
  
  .table-notes {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 10px;
  }
  
  .table-notes thead {
    background-color: #2c3e50;
    color: white;
  }
  
  .table-notes th {
    padding: 6px 8px;
    text-align: left;
    font-weight: 600;
    border: 1px solid #ddd;
    font-size: 12px;
    color: #000 !important;
  }
  
  .table-notes td {
    padding: 6px 8px;
    border: 1px solid #ddd;
    text-align: center;
    font-size: 12px;
  }
  
  .table-notes tbody tr:nth-child(even) {
    background-color: #f8f9fa;
  }
  
  .table-notes tbody tr:hover {
    background-color: #e9ecef;
  }
  
  .matiere-col {
    text-align: left;
    font-weight: 500;
    color: #2c3e50;
  }
  
  .note-col {
    font-weight: 600;
    color: #667eea;
  }
  
  .apprec-col {
    text-align: left;
    font-size: 13px;
    color: #555;
  }
  
  /* Moyennes */
  .moyennes-section {
    background: #f8f9fb;
    padding: 10px;
    border-radius: 4px;
    margin-bottom: 8px;
    border-left: 3px solid #667eea;
  }
  
  .moyennes-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
    margin-bottom: 0;
  }

  .moyenne-box {
    background: white;
    padding: 8px;
    border-radius: 4px;
    text-align: center;
    border: 1px solid #dfe7ff;
  }

  .moyenne-label {
    font-size: 10px;
    color: #7f8c8d;
    font-weight: 600;
    text-transform: uppercase;
    margin-bottom: 4px;
  }

  .moyenne-value {
    font-size: 16px;
    font-weight: 700;
    color: #3a3b3f;
  }
  
  /* Décision du Conseil */
  .decision-section {
    background: linear-gradient(135deg, #912929 0%, #583431 100%);
    color: white;
    padding: 8px 13px;
    border-radius: 4px;
    margin-bottom: 8px;
    text-align: left;
    display: flex;
    align-items: center;
    white-space: nowrap;
    min-height: 51px;
  }
  
  .decision-label {
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 10px;
    font-weight: 600;
  }
  
  .decision-text {
    font-size: 14px;
    font-weight: 700;
    margin-bottom: 6px;
  }
  
  .appreciation-text {
    font-size: 14px;
    font-style: italic;
    margin-bottom: 0;
  }
  
  /* Pied de page */
  .bulletin-footer {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-top: 13px;
    padding-top: 0;
  }
  
  .footer-section {
    text-align: center;
  }
  
  .footer-label {
    font-size: 12px;
    color: #7f8c8d;
    font-weight: 600;
    margin-top: 60px;
    text-transform: uppercase;
  }
  
  .cachet-space {
    border: 2px dashed #bdc3c7;
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #bdc3c7;
    font-size: 12px;
    border-radius: 4px;
    margin-bottom: 10px;
  }
  
  .date-validation {
    font-size: 12px;
    color: #555;
    margin-top: 10px;
  }
  
  /* Excellentes notes */
  .note-excellent {
    background-color: #d4edda;
    color: #155724;
    padding: 3px 8px;
    border-radius: 3px;
    font-weight: 600;
  }
  
  .note-bien {
    background-color: #d1ecf1;
    color: #0c5460;
    padding: 3px 8px;
    border-radius: 3px;
  }
  
  .note-moyen {
    background-color: #fff3cd;
    color: #856404;
    padding: 3px 8px;
    border-radius: 3px;
  }
  
  .note-insuffisant {
    background-color: #f8d7da;
    color: #721c24;
    padding: 3px 8px;
    border-radius: 3px;
    font-weight: 600;
  }
  
  /* Print styles */
  @media print {
    body {
      margin: 0;
      padding: 0;
      line-height: 1.4;
    }
    /* Cacher les éléments UI non nécessaires */
    .search-container,
    .btn-group,
    .alert,
    .autocomplete-results,
    .result-item,
    header,
    footer,
    .d-flex.gap-2.justify-content-center,
    .container > :not(.bulletin-container) {
      display: none !important;
    }

    /* Optimiser le rendu pour A4 */
    .bulletin-container {
      page-break-after: always;
      box-shadow: none;
      border: none;
      margin: 0;
      padding: 10px;
      max-width: 190mm;
    }

    /* Réduire tailles générales pour tenir sur A4 */
    body, .bulletin-container, .table-notes, .moyennes-section, .decision-section {
      font-size: 13px !important;
    }

    /* En-tête et infos étudiants */
    .bulletin-header {
      padding-bottom: 3px !important;
      margin-bottom: 6px !important;
    }

    .bulletin-titre {
      font-size: 18px !important;
      margin-top: 10px !important;
    }

    .etablissement-nom {
      font-size: 20px !important;
    }

    .etablissement-adresse {
      font-size: 12px !important;
    }

    .student-info {
      margin-bottom: 6px !important;
      padding: 8px !important;
      gap: 12px !important;
    }

    .info-row {
      padding-bottom: 3px !important;
    }

    .info-label {
      font-size: 12px !important;
      min-width: 127px !important;
    }

    .info-value {
      font-size: 12px !important;
    }

    /* Tableau */
    .table-notes {
      margin-bottom: 6px !important;
      font-size: 12px !important;
    }

    .table-notes th, .table-notes td {
      padding: 4px 6px !important;
      font-size: 12px !important;
    }

    .table-notes th {
      font-size: 11px !important;
    }

    .matiere-col {
      font-size: 12px !important;
    }

    /* Moyennes et décision */
    .moyennes-section {
      margin-bottom: 3px !important;
      padding: 6px !important;
      background: #f8f9fb !important;
    }

    .moyenne-box {
      padding: 6px !important;
      font-size: 12px !important;
    }

    .moyenne-label {
      font-size: 10px !important;
    }

    .moyenne-value {
      font-size: 15px !important;
    }

    .decision-section {
      margin-bottom: 3px !important;
      padding: 6px 10px !important;
      min-height: 39px !important;
      font-size: 13px !important;
    }

    .decision-label {
      font-size: 13px !important;
    }

    .decision-text {
      font-size: 13px !important;
    }

    /* Pied de page */
    .bulletin-footer {
      margin-top: 3px !important;
      padding-top: 0 !important;
      gap: 6px !important;
    }

    .footer-section {
      margin-bottom: 0 !important;
    }

    .footer-label {
      margin-top: 10px !important;
      font-size: 11px !important;
    }

    .cachet-space {
      height: 51px !important;
      margin-bottom: 3px !important;
      font-size: 10px !important;
      border: 1px dashed #bdc3c7 !important;
    }

    .date-validation {
      margin-top: 3px !important;
      font-size: 11px !important;
    }
  }
</style>

<!-- Section Recherche -->
<div class="search-container">
  <div class="d-flex justify-content-between align-items-center">
    <div style="flex: 1;">
      <h3><i class="fas fa-search me-2"></i>Rechercher un élève</h3>
      <form method="get" action="/bulletin" id="searchForm" class="position-relative">
        <div class="position-relative">
          <input type="text" name="matricule" id="matricule" class="form-control form-control-lg" 
                 placeholder="Tapez le matricule, nom ou prénom..." 
                 value="<%= (query && query.matricule) || '' %>" 
                 autocomplete="off"
                 style="padding: 12px 15px;">
          <div id="searchResults" class="autocomplete-results"></div>
        </div>
        <small style="display: block; margin-top: 8px; opacity: 0.9;">
          <i class="fas fa-info-circle me-1"></i> Tapez au moins 2 caractères pour voir les suggestions
        </small>
      </form>
    </div>
    <button type="submit" form="searchForm" class="btn btn-light btn-lg ms-3" style="white-space: nowrap;">
      <i class="fas fa-search me-1"></i>Rechercher
    </button>
  </div>
</div>

<!-- Bulletin de notes -->
<% if (etudiant) { %>
<div class="bulletin-container" id="bulletinContent">
  
  <!-- EN-TÊTE OFFICIEL -->
  <div class="bulletin-header">
    <div class="etablissement-nom">ÉCOLE CATHOLIQUE NOTRE DAME</div>
    <div class="etablissement-adresse">B.P 235 MAHAJANGA • Tél: +261 032 05 355 06• www.ecole-notredame-mahajanga.mg</div>
    <div class="bulletin-titre">BULLETIN DE NOTES</div>
    <div class="bulletin-annee">Année scolaire 2022 - 2023</div>
    <div class="student-info">
      <div>
        <div class="info-row">
          <span class="info-label">Nom et Prénom :</span>
          <span class="info-value"><strong><%= etudiant.prenom %> <%= etudiant.nom %></strong></span>
        </div>
        <div class="info-row">
          <span class="info-label">Classe :</span>
          <span class="info-value"><%= etudiant.classe || 'N/A' %></span>
        </div>
      </div>
      <div>
        <div class="info-row">
          <span class="info-label">Numéro Matricule :</span>
          <span class="info-value"><strong><%= etudiant.numero_matricule %></strong></span>
        </div>
        <div class="info-row">
          <span class="info-label">Niveau :</span>
          <span class="info-value"><%= etudiant.niveau || 'N/A' %></span>
        </div>
      </div>
    </div>
  </div>

  <!-- TABLEAU DES NOTES -->
  <% 
    const matieres = [
      'Catéchèse',
      'Philosophie / Initiation',
      'Malagasy',
      'Français',
      'Anglais',
      'Espagnol',
      'Histoire - Géographie',
      'Mathématiques',
      'Physique - Chimie',
      'SVT',
      'Informatique',
      'EPS'
    ];
    
    const sessions = ['1er', '2ème', '3ème'];
    
    // Créer un index des notes pour accès rapide
    let notesIndex = {};
    if (allNotes && allNotes.length > 0) {
      allNotes.forEach(note => {
        const key = `${note.matiere}_${note.session}_${note.type_evaluation}`;
        // Préférer les notes de Contrôle Continu
        if (!notesIndex[`${note.matiere}_${note.session}`] || note.type_evaluation === 'Controle Continu') {
          notesIndex[`${note.matiere}_${note.session}`] = note.note;
        }
      });
    }
    
    // Organiser les notes par matière et session
    let notesByMatiere = {};
    matieres.forEach(m => {
      notesByMatiere[m] = {};
      sessions.forEach(s => {
        notesByMatiere[m][s] = notesIndex[`${m}_${s}`] || null;
      });
    });
    
    // Calcul des moyennes par matière
    function getAnnualAverage(matiere) {
      const notes = sessions.map(s => notesByMatiere[matiere][s]).filter(n => n !== null);
      if (notes.length === 0) return null;
      return (notes.reduce((a,b) => a+b, 0) / notes.length).toFixed(2);
    }
    
    // Appréciation automatique
    function getAppreciation(note) {
      if (note === null) return '—';
      const n = parseFloat(note);
      if (n >= 18) return 'Excellent – Travail remarquable';
      if (n >= 16) return 'Très bien – Très bon niveau';
      if (n >= 14) return 'Bien – Bon travail';
      if (n >= 12) return 'Assez bien – Efforts satisfaisants';
      if (n >= 10) return 'Passable – Peut mieux faire';
      return 'Insuffisant – Doit fournir plus d\'efforts';
    }
    
    function getNoteClass(note) {
      if (note === null) return '';
      const n = parseFloat(note);
      if (n >= 16) return 'note-excellent';
      if (n >= 14) return 'note-bien';
      if (n >= 10) return 'note-moyen';
      return 'note-insuffisant';
    }
  %>
  
  <table class="table-notes">
    <thead>
      <tr>
        <th style="width: 25%;color:#000;">Matière</th>
        <th style="width: 12%;color:#000;">1er Trim.</th>
        <th style="width: 12%;color:#000;">2e Trim.</th>
        <th style="width: 12%;color:#000;">3e Trim.</th>
        <th style="width: 12%;color:#000;">Moyenne</th>
        <th style="width: 27%;color:#000;">Appréciation</th>
      </tr>
    </thead>
    <tbody>
      <% matieres.forEach(matiere => {
        const annualAvg = getAnnualAverage(matiere);
        const appreciation = getAppreciation(annualAvg);
      %>
      <tr>
        <td class="matiere-col"><%= matiere %></td>
        <td class="note-col">
          <% if (notesByMatiere[matiere]['1er'] !== null) { %>
            <span class="<%= getNoteClass(notesByMatiere[matiere]['1er']) %>">
              <%= parseFloat(notesByMatiere[matiere]['1er']).toFixed(2) %>
            </span>
          <% } else { %>
            <span style="color: #bdc3c7;">—</span>
          <% } %>
        </td>
        <td class="note-col">
          <% if (notesByMatiere[matiere]['2ème'] !== null) { %>
            <span class="<%= getNoteClass(notesByMatiere[matiere]['2ème']) %>">
              <%= parseFloat(notesByMatiere[matiere]['2ème']).toFixed(2) %>
            </span>
          <% } else { %>
            <span style="color: #bdc3c7;">—</span>
          <% } %>
        </td>
        <td class="note-col">
          <% if (notesByMatiere[matiere]['3ème'] !== null) { %>
            <span class="<%= getNoteClass(notesByMatiere[matiere]['3ème']) %>">
              <%= parseFloat(notesByMatiere[matiere]['3ème']).toFixed(2) %>
            </span>
          <% } else { %>
            <span style="color: #bdc3c7;">—</span>
          <% } %>
        </td>
        <td class="note-col" style="font-size: 16px;">
          <% if (annualAvg !== null) { %>
            <strong class="<%= getNoteClass(annualAvg) %>"><%= annualAvg %></strong>
          <% } else { %>
            <span style="color: #bdc3c7;">—</span>
          <% } %>
        </td>
        <td class="apprec-col"><%= appreciation %></td>
      </tr>
      <% }); %>
    </tbody>
  </table>

  <!-- MOYENNES GÉNÉRALES + DÉCISION (sur la même ligne) -->
  <% 
    const calculateTrimesterAverage = (trimester) => {
      let total = 0;
      let count = 0;
      matieres.forEach(m => {
        const note = notesByMatiere[m][trimester];
        if (note !== null) {
          total += parseFloat(note);
          count++;
        }
      });
      return count > 0 ? (total / count).toFixed(2) : '—';
    };
    
    const t1Avg = calculateTrimesterAverage('1er');
    const t2Avg = calculateTrimesterAverage('2ème');
    const t3Avg = calculateTrimesterAverage('3ème');
    
    let annualAverage = '—';
    if (t1Avg !== '—' && t2Avg !== '—' && t3Avg !== '—') {
      annualAverage = ((parseFloat(t1Avg) + parseFloat(t2Avg) + parseFloat(t3Avg)) / 3).toFixed(2);
    }
    
    // Calculer la décision
    let decision = '—';
    if (annualAverage !== '—') {
      const avg = parseFloat(annualAverage);
      if (avg >= 16) decision = 'Admis(e) avec félicitations';
      else if (avg >= 14) decision = 'Admis(e)';
      else if (avg >= 12) decision = 'Admis(e) avec encouragements';
      else if (avg >= 10) decision = 'Admis(e) sous réserve';
      else decision = 'Redoublement conseillé';
    }
  %>

  <div class="moyennes-section compact-moyennes" style="display:flex;gap:12px;align-items:stretch;margin-bottom:12px;">
    <!-- Bloc Moyennes -->
    <div style="display:flex;gap:8px;align-items:center;flex:1;">
      <div class="moyenne-box" style="padding:6px;min-width:60px;text-align:center;">
        <div class="moyenne-label">1er</div>
        <div class="moyenne-value"><%= t1Avg %></div>
      </div>
      <div class="moyenne-box" style="padding:6px;min-width:60px;text-align:center;">
        <div class="moyenne-label">2ème</div>
        <div class="moyenne-value"><%= t2Avg %></div>
      </div>
      <div class="moyenne-box" style="padding:6px;min-width:60px;text-align:center;">
        <div class="moyenne-label">3ème</div>
        <div class="moyenne-value"><%= t3Avg %></div>
      </div>
      <div class="moyenne-box" style="padding:6px;min-width:80px;border-color:#ffc107;background:#fffbf0;text-align:center;">
        <div class="moyenne-label" style="color:#f39c12;">Annuel</div>
        <div class="moyenne-value" style="color:#f39c12;font-size:16px;"><strong><%= annualAverage %></strong></div>
      </div>
    </div>

    <!-- Bloc Décision (aligné à gauche sur la même ligne) -->
    <div class="decision-section compact-decision" style="flex:1;padding:8px;color:#000;gap:10px;">
      <div style="display:flex;flex-direction:row;align-items:center;gap:8px;white-space:nowrap;">
        <span class="decision-label" style="font-size:12px;color:#000;margin:0;">Décision:</span>
        <span class="decision-text" style="font-size:13px;font-weight:700;color:#000;margin:0;"><%= decision %></span>
      </div>
    </div>
  </div>

  <!-- DÉCISION DU CONSEIL DE CLASSE (compact) -->
  <!-- DÉCISION DU CONSEIL DE CLASSE (compact) - removed duplicate; `decision` already set above -->

  <!-- PIED DE PAGE -->
  <div class="bulletin-footer">
    <div class="footer-section">
      <div class="cachet-space">
        <i class="fas fa-stamp"></i> Cachet de l'établissement
      </div>
      <div class="footer-label">Cachet Officiel</div>
    </div>
    <div class="footer-section">
      <div style="height: 80px; border-bottom: 2px solid #2c3e50; display: flex; align-items: flex-end; justify-content: center;">
        <span style="font-size: 10px; color: #bdc3c7; margin-bottom: 5px;">Signature</span>
      </div>
      <div class="footer-label">Responsable Pédagogique</div>
      <div class="date-validation">Date : <span id="currentDate"></span></div>
    </div>
  </div>

</div>

<!-- BOUTONS D'ACTION -->
<div class="d-flex gap-2 justify-content-center mt-4">
  <button onclick="generatePDF()" class="btn btn-success btn-lg" id="btnPDF">
    <i class="fas fa-file-pdf me-2"></i>Télécharger en PDF
  </button>
  <button onclick="window.print()" class="btn btn-primary btn-lg">
    <i class="fas fa-print me-2"></i>Imprimer
  </button>
  <a href="/bulletin" class="btn btn-outline-secondary btn-lg">
    <i class="fas fa-search me-2"></i>Autre élève
  </a>
</div>
<% } %>

<% if (!etudiant) { %>
<div class="alert alert-info mt-4">
  <i class="fas fa-info-circle me-2"></i>
  <strong>Instructions :</strong> Utilisez la barre de recherche ci-dessus pour trouver un élève et afficher son bulletin de notes.
</div>
<% } %>

<!-- Script principal déplacé plus bas; ancien bloc supprimé pour éviter duplications -->

<!-- (Bloc d'affichage secondaire supprimé pour éviter duplication des en-têtes) -->

<script>
function generatePDF() {
  // Redirection vers la route de génération PDF
  const matricule = document.getElementById('matricule').value;
  if (matricule) {
    window.open('/bulletin/pdf?matricule=' + encodeURIComponent(matricule), '_blank');
  }
}

// Fonctionnalité d'autocomplétion
document.addEventListener('DOMContentLoaded', function() {
  const searchInput = document.getElementById('matricule');
  const searchResults = document.getElementById('searchResults');
  let searchTimeout;
  let currentResults = [];

  // Fonction de debounce pour éviter trop de requêtes
  function debounce(func, wait) {
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(searchTimeout);
        func(...args);
      };
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(later, wait);
    };
  }

  // Recherche d'étudiants
  async function searchEtudiants(query) {
    if (query.length < 2) {
      hideResults();
      return;
    }

    try {
      const response = await fetch(`/api/etudiants/search?q=${encodeURIComponent(query)}`);
      const data = await response.json();
      
      if (data.success) {
        currentResults = data.etudiants;
        displayResults(data.etudiants);
      }
    } catch (error) {
      console.error('Erreur recherche:', error);
      hideResults();
    }
  }

  // Afficher les résultats
  function displayResults(etudiants) {
    if (etudiants.length === 0) {
      hideResults();
      return;
    }

    const html = etudiants.map(etudiant => `
      <div class="autocomplete-item" data-matricule="${etudiant.matricule}">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <strong>${etudiant.prenom} ${etudiant.nom}</strong>
            <br>
            <small class="text-muted">
              <i class="fas fa-id-card me-1"></i>${etudiant.matricule} | 
              <i class="fas fa-graduation-cap me-1"></i>${etudiant.niveau} | 
              <i class="fas fa-users me-1"></i>${etudiant.classe}
            </small>
          </div>
          <i class="fas fa-arrow-right text-primary"></i>
        </div>
      </div>
    `).join('');

    searchResults.innerHTML = html;
    searchResults.style.display = 'block';

    // Ajouter les événements de clic
    document.querySelectorAll('.autocomplete-item').forEach(item => {
      item.addEventListener('click', function() {
        const matricule = this.dataset.matricule;
        searchInput.value = matricule;
        hideResults();
        // Optionnel : soumettre automatiquement le formulaire
        // document.getElementById('searchForm').submit();
      });

      item.addEventListener('mouseenter', function() {
        this.classList.add('active');
      });

      item.addEventListener('mouseleave', function() {
        this.classList.remove('active');
      });
    });
  }

  // Masquer les résultats
  function hideResults() {
    searchResults.style.display = 'none';
    searchResults.innerHTML = '';
  }

  // Recherche avec debounce
  const debouncedSearch = debounce(searchEtudiants, 300);

  // Événements
  searchInput.addEventListener('input', function() {
    const query = this.value.trim();
    debouncedSearch(query);
  });

  searchInput.addEventListener('focus', function() {
    if (currentResults.length > 0) {
      searchResults.style.display = 'block';
    }
  });

  // Masquer les résultats quand on clique ailleurs
  document.addEventListener('click', function(e) {
    if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
      hideResults();
    }
  });

  // Navigation au clavier
  let selectedIndex = -1;
  searchInput.addEventListener('keydown', function(e) {
    const items = document.querySelectorAll('.autocomplete-item');
    
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
      updateSelection(items, selectedIndex);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      selectedIndex = Math.max(selectedIndex - 1, -1);
      updateSelection(items, selectedIndex);
    } else if (e.key === 'Enter' && selectedIndex >= 0) {
      e.preventDefault();
      items[selectedIndex].click();
    } else if (e.key === 'Escape') {
      hideResults();
      selectedIndex = -1;
    }
  });

  function updateSelection(items, index) {
    items.forEach((item, i) => {
      item.classList.toggle('active', i === index);
    });
  }
});
</script>

<style>
/* Styles pour l'autocomplétion */
.autocomplete-results {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: white;
  border: 1px solid #dee2e6;
  border-top: none;
  border-radius: 0 0 8px 8px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  z-index: 1000;
  max-height: 300px;
  overflow-y: auto;
  display: none;
}

.autocomplete-item {
  padding: 12px 15px;
  border-bottom: 1px solid #f8f9fa;
  cursor: pointer;
  transition: all 0.2s ease;
}

.autocomplete-item:hover,
.autocomplete-item.active {
  background-color: #f8f9fa;
  border-left: 3px solid #667eea;
}

.autocomplete-item:last-child {
  border-bottom: none;
}

.autocomplete-item strong {
  color: #333;
  font-size: 0.95rem;
}

.autocomplete-item small {
  font-size: 0.8rem;
}

.autocomplete-item i {
  font-size: 0.75rem;
}

/* Amélioration du champ de recherche */
#matricule {
  border-radius: 8px 8px 0 0;
  border-bottom: none;
}

#matricule:focus {
  border-color: #667eea;
  box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
  border-radius: 8px 8px 0 0;
}

/* Animation pour les résultats */
.autocomplete-results {
  animation: slideDown 0.2s ease-out;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Responsive */
@media (max-width: 768px) {
  .autocomplete-item {
    padding: 10px 12px;
  }
  
  .autocomplete-item small {
    font-size: 0.75rem;
  }
}

/* Styles d'impression */
@media print {
  .card-header .btn, .card-header .d-flex {
    display: none !important;
  }
  .card {
    border: none !important;
    box-shadow: none !important;
  }
  /* Masquer les instructions lors de l'impression */
  .alert-info, .card:has(.alert-info) {
    display: none !important;
  }
  /* Masquer la section de recherche */
  .row:first-of-type {
    display: none !important;
  }
  /* Masquer le titre "Génération de bulletins" */
  h1 {
    display: none !important;
  }
  /* Masquer la navigation */
  header {
    display: none !important;
  }
  /* Masquer le footer */
  footer {
    display: none !important;
  }
  /* Optimiser l'espace pour le bulletin */
  body {
    margin: 0 !important;
    padding: 10px !important;
  }
  .container {
    max-width: none !important;
    padding: 0 !important;
  }
  /* Styles pour l'en-tête d'impression */
  .text-center h4 {
    font-size: 14px !important;
    margin-bottom: 2px !important;
  }
  .text-center p {
    margin-bottom: 1px !important;
    font-size: 10px !important;
  }
  /* Réduire l'espacement général */
  .row {
    margin-bottom: 5px !important;
  }
  .table {
    font-size: 11px !important;
  }
  .table th, .table td {
    padding: 4px 6px !important;
  }
}
</style>

<%- include('partials/footer') %>

<script>
// Écouter les changements d'année scolaire déclenchés par la transition
window.addEventListener('storage', function(event) {
  if (!event) return;
  if (event.key === 'annee_scolaire_changed_at') {
    console.info('Année scolaire modifiée dans un autre onglet — rechargement du bulletin');
    // Recharger la page pour actualiser les données du bulletin
    location.reload();
  }
});
</script>
<%- include('partials/footer') %>